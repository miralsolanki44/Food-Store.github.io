define(['jquery','underscore','Magento_Customer/js/customer-data'],function($,_,customerData){"use strict";var debugMode=window.wavesDebugMode||false;var widgetMixin={track:function(){if(debugMode){console.dir('track method:');}
var waves=customerData.get('waves')();var _rsq=window._rsq=window._rsq||[];if(_.isArray(this.options.track)){_.each(this.options.track,function(el){_rsq.push(el);});}
this.trackCustomerId(_rsq);if(debugMode){console.dir(_rsq);}
this.options.cart.now&&this.trackCartItems(_rsq);if(this.options.checkout_success){var wavesOrder=customerData.get('waves-order')();if(('id'in wavesOrder)&&wavesOrder.id){_.each(wavesOrder.items,function(item){if(debugMode){console.dir(item);}
_rsq.push(['_addItem',item]);});_rsq.push(['_addOrder',{id:wavesOrder.id,total:wavesOrder.total}]);_rsq.push(['_setAction','checkout_success']);if(debugMode){console.dir(_rsq);}}}
_rsq.push(['_track']);this.loadRS();},trackCartItems:function(_rsq){var cart=customerData.get('cart')(),newCartItems=[],hasDiff;if(!cart||!('items'in cart)||!cart.items.length){return;}
_.each(cart.items,function(item){newCartItems.push(item.item_id+' '+item.qty);});if(debugMode){console.dir(cart.items);console.dir(this.sentCartItems);console.dir(newCartItems);}
hasDiff=!(_.intersection(this.sentCartItems,newCartItems).length===this.sentCartItems.length&&this.sentCartItems.length===newCartItems.length);if(hasDiff){_.each(cart.items,function(item){if(debugMode){console.log('trackCartItem');console.dir(item);}
_rsq.push(['_addItem',{id:item.product_sku,name:item.product_name,price:item.product_price_value}]);});_rsq.push(['_setAction','shopping_cart']);this.sentCartItems=newCartItems;if(debugMode){console.dir(_rsq);}}}};return function(targetWidget){$.widget('rs.waves',targetWidget,widgetMixin);return $.rs.waves;};});